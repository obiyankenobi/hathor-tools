<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hathor Nano Contract Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 912px;
            margin: 0 auto;
            padding: 20px 40px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        h1 {
            color: #ffffff;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #444;
        }
        .section:last-child {
            border-bottom: none;
        }
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 16px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #3d3d3d;
            color: #ffffff;
            font-family: monospace;
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .form-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            transition: background-color 0.3s ease;
        }
        .form-button:hover:enabled {
            background-color: #45a049;
        }
        .form-button:disabled {
            background-color: #2d2d2d;
            cursor: not-allowed;
            border: 1px solid #444;
            opacity: 0.6;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            display: none;
        }
        .loading .spinner {
            display: inline-block;
        }
        .loading .button-text {
            display: none;
        }
        .feedback {
            margin-top: 16px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #1b5e20;
            color: #ffffff;
        }
        .error {
            background-color: #b71c1c;
            color: #ffffff;
            line-height: 1.5;
        }
        .hash {
            font-family: monospace;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background-color: #3d3d3d;
            border-radius: 4px;
            color: #4CAF50;
        }
        .hash a {
            color: #4CAF50;
            text-decoration: none;
        }
        .hash a:hover {
            text-decoration: underline;
        }
        .section-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .section-enabled {
            opacity: 1;
            pointer-events: auto;
        }
        .init-info-block {
            margin-bottom: 20px;
        }
        .init-info-block div {
            margin-bottom: 10px;
        }
        .init-info-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hathor Nano Contract Creator</h1>
        <!-- Section 1: Fetch blueprint info -->
        <div class="section" id="section1">
            <div class="section-title">Fetch blueprint info</div>
            <form id="fetchBlueprintForm">
                <label class="form-label" for="blueprintIdInput">Blueprint ID (64-char hex)</label>
                <input class="form-input" id="blueprintIdInput" maxlength="64" minlength="64" required pattern="[a-fA-F0-9]{64}" placeholder="e.g. 0123abcd..." autocomplete="off">
                <button type="submit" id="fetchBlueprintBtn" class="form-button">
                    <div class="spinner"></div>
                    <span class="button-text">Fetch blueprint info</span>
                </button>
            </form>
            <div id="fetchBlueprintFeedback" class="feedback"></div>
        </div>
        <!-- Section 2: Initialize method -->
        <div class="section section-disabled" id="section2">
            <div class="section-title">Initialize method</div>
            <div id="initInfo" class="init-info-block"></div>
            <form id="initForm" style="display:none;">
                <div id="initFormFields"></div>
                <button type="submit" id="initBtn" class="form-button" disabled>
                    <div class="spinner"></div>
                    <span class="button-text">Create nano contract</span>
                </button>
            </form>
            <div id="initFeedback" class="feedback"></div>
        </div>
    </div>
    <script>
        // Validation helpers
        function isHex64(str) {
            return /^[a-fA-F0-9]{64}$/.test(str);
        }
        function isInteger(str) {
            return /^-?\d+$/.test(str);
        }
        function isBase58(str) {
            const base58Chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            return str.split('').every(char => base58Chars.includes(char));
        }
        // Section 1: Fetch blueprint info
        const fetchBlueprintForm = document.getElementById('fetchBlueprintForm');
        const blueprintIdInput = document.getElementById('blueprintIdInput');
        const fetchBlueprintBtn = document.getElementById('fetchBlueprintBtn');
        const fetchBlueprintFeedback = document.getElementById('fetchBlueprintFeedback');
        const section2 = document.getElementById('section2');
        const initInfo = document.getElementById('initInfo');
        const initForm = document.getElementById('initForm');
        const initFormFields = document.getElementById('initFormFields');
        const initBtn = document.getElementById('initBtn');
        const initFeedback = document.getElementById('initFeedback');
        let objectA = null;
        fetchBlueprintForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            fetchBlueprintFeedback.className = 'feedback';
            fetchBlueprintFeedback.textContent = '';
            // Reset section 2
            section2.className = 'section section-disabled';
            initInfo.innerHTML = '';
            initForm.style.display = 'none';
            initFormFields.innerHTML = '';
            initBtn.disabled = true;
            initFeedback.className = 'feedback';
            initFeedback.textContent = '';
            // Validate input
            const blueprintId = blueprintIdInput.value.trim();
            if (!isHex64(blueprintId)) {
                fetchBlueprintFeedback.className = 'feedback error';
                fetchBlueprintFeedback.textContent = 'Invalid blueprint ID: must be 64 hexadecimal characters.';
                return;
            }
            // Loading state
            fetchBlueprintBtn.disabled = true;
            fetchBlueprintBtn.classList.add('loading');
            try {
                const resp = await fetch(`https://node1.hackaton.hathor.network/v1a/nano_contract/blueprint/info?blueprint_id=${blueprintId}`);
                const data = await resp.json();
                if (data.success === false) {
                    fetchBlueprintFeedback.className = 'feedback error';
                    fetchBlueprintFeedback.textContent = data.error || 'Unknown error.';
                    return;
                }
                if (!data.id) {
                    fetchBlueprintFeedback.className = 'feedback error';
                    fetchBlueprintFeedback.textContent = 'Error fetching blueprint information';
                    return;
                }
                // Success
                objectA = data;
                fetchBlueprintFeedback.className = 'feedback success';
                fetchBlueprintFeedback.textContent = 'Blueprint info loaded.';
                // Enable section 2
                section2.className = 'section section-enabled';
                // Show info
                let docstring = objectA.docstring || 'not provided';
                let initDoc = (objectA.public_methods && objectA.public_methods.initialize && objectA.public_methods.initialize.docstring) ? objectA.public_methods.initialize.docstring : 'not provided';
                initInfo.innerHTML = `<div><span class='init-info-label'>Name:</span> <b>${objectA.name || 'not provided'}</b></div>` +
                    `<div><span class='init-info-label'>Description:</span> <span>${docstring}</span></div>` +
                    `<div><span class='init-info-label'>Initialize method docstring:</span> <span>${initDoc}</span></div>`;
                // Build dynamic form
                const args = (objectA.public_methods && objectA.public_methods.initialize && objectA.public_methods.initialize.args) ? objectA.public_methods.initialize.args : [];
                if (args.length > 0) {
                    initFormFields.innerHTML = '';
                    args.forEach((arg, idx) => {
                        let placeholder = '';
                        let validate = '';
                        switch(arg.type) {
                            case 'VertexId':
                            case 'TokenUid':
                            case 'ContractId':
                            case 'BlueprintId':
                                placeholder = '64 char hexadecimal';
                                validate = 'hex64';
                                break;
                            case 'Amount':
                            case 'Timestamp':
                                placeholder = 'integer';
                                validate = 'int';
                                break;
                            case 'Address':
                                placeholder = 'base58 string';
                                validate = 'base58';
                                break;
                            case 'TxOutputScript':
                                placeholder = 'string';
                                validate = 'none';
                                break;
                            default:
                                placeholder = arg.type;
                                validate = 'none';
                        }
                        initFormFields.innerHTML += `<label class="form-label" for="arg_${idx}">${arg.name} (${arg.type})</label>` +
                            `<input class="form-input" id="arg_${idx}" name="arg_${idx}" data-validate="${validate}" placeholder="${placeholder}" required>`;
                    });
                    initForm.style.display = '';
                    initBtn.disabled = false;
                } else {
                    initFormFields.innerHTML = '<div>No arguments required for initialize method.</div>';
                    initForm.style.display = '';
                    initBtn.disabled = false;
                }
            } catch (err) {
                fetchBlueprintFeedback.className = 'feedback error';
                fetchBlueprintFeedback.textContent = 'Error fetching blueprint information';
            } finally {
                fetchBlueprintBtn.disabled = false;
                fetchBlueprintBtn.classList.remove('loading');
            }
        });
        // Section 2: Initialize method
        initForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            initFeedback.className = 'feedback';
            initFeedback.textContent = '';
            initBtn.disabled = true;
            initBtn.classList.add('loading');
            // Validate all fields
            const args = (objectA.public_methods && objectA.public_methods.initialize && objectA.public_methods.initialize.args) ? objectA.public_methods.initialize.args : [];
            let values = [];
            let valid = true;
            for (let i = 0; i < args.length; i++) {
                const input = document.getElementById(`arg_${i}`);
                const val = input.value.trim();
                const validate = input.getAttribute('data-validate');
                if (validate === 'hex64' && !isHex64(val)) {
                    input.style.borderColor = '#b71c1c';
                    valid = false;
                } else if (validate === 'int' && !isInteger(val)) {
                    input.style.borderColor = '#b71c1c';
                    valid = false;
                } else if (validate === 'base58' && !isBase58(val)) {
                    input.style.borderColor = '#b71c1c';
                    valid = false;
                } else {
                    input.style.borderColor = '#444';
                }
                values.push(val);
            }
            if (!valid) {
                initFeedback.className = 'feedback error';
                initFeedback.textContent = 'Please correct the highlighted fields.';
                initBtn.disabled = false;
                initBtn.classList.remove('loading');
                return;
            }
            // Prepare payload
            const payload = {
                blueprint_id: objectA.id,
                address: "WR576kjGacfQF5t5Zdeqz9pnSQFHHNYkRw",
                data: {
                    args: values
                }
            };
            try {
                const resp = await fetch('/create-contract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (!('success' in data)) {
                    initFeedback.className = 'feedback error';
                    initFeedback.textContent = 'Error: Invalid response from server.';
                    return;
                }
                if (!data.success) {
                    initFeedback.className = 'feedback error';
                    initFeedback.textContent = data.message || 'Error creating contract.';
                    return;
                }
                // Success
                initFeedback.className = 'feedback success';
                initFeedback.innerHTML = `Contract created: <div class="hash"><a href="https://node1.hackaton.hathor.network/v1a/nano_contract/${data.nc_id}" target="_blank">${data.nc_id}</a></div>`;
            } catch (err) {
                initFeedback.className = 'feedback error';
                initFeedback.textContent = 'Error creating contract.';
            } finally {
                initBtn.disabled = false;
                initBtn.classList.remove('loading');
            }
        });
    </script>
</body>
</html> 